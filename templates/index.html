<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF/å›¾ç‰‡æ™ºèƒ½è¯†åˆ«ç³»ç»Ÿ</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; 
      margin: 0;
      padding: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .card { 
      max-width: 720px; 
      margin: 0 auto; 
      padding: 32px; 
      background: white;
      border-radius: 16px; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    }
    h1 { 
      font-size: 24px; 
      margin: 0 0 8px; 
      color: #1a1a2e;
    }
    .subtitle {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 24px;
    }
    .hint { 
      color: #6b7280; 
      margin-bottom: 16px; 
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      font-size: 14px;
    }
    .error { 
      color: #b91c1c; 
      background: #fef2f2;
    }
    .ok { 
      color: #16a34a; 
      background: #f0fdf4;
    }
    .row { margin-top: 16px; }
    .file-input-wrapper {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 32px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .file-input-wrapper:hover {
      border-color: #667eea;
      background: #f5f3ff;
    }
    .file-input-wrapper input {
      display: none;
    }
    .file-label {
      color: #374151;
      font-size: 15px;
    }
    .file-label strong {
      color: #667eea;
    }
    
    /* æ¨¡å¼é€‰æ‹©æ ·å¼ */
    .mode-selector {
      display: flex;
      gap: 16px;
      margin-top: 20px;
    }
    .mode-option {
      flex: 1;
      position: relative;
    }
    .mode-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
      z-index: 2;
    }
    .mode-card {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      background: #f9fafb;
    }
    .mode-option input[type="radio"]:checked + .mode-card {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }
    .mode-option:hover .mode-card {
      border-color: #667eea;
    }
    .mode-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    .mode-title {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a2e;
      margin-bottom: 4px;
    }
    .mode-desc {
      font-size: 12px;
      color: #6b7280;
    }
    .mode-output {
      font-size: 11px;
      color: #667eea;
      margin-top: 8px;
      font-weight: 500;
    }
    
    button { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; 
      border: none; 
      padding: 12px 24px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 15px;
      font-weight: 500;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:disabled { 
      background: #9ca3af; 
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .features {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }
    .feature {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #f9fafb;
      border-radius: 8px;
    }
    .feature-icon {
      font-size: 20px;
    }
    .feature-text {
      color: #6b7280;
      font-size: 13px;
    }
    
    /* API é…ç½®è¾“å…¥æ¡†æ ·å¼ */
    .api-config {
      margin-top: 20px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    .api-config-title {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .api-config-toggle {
      margin-left: auto;
      font-size: 12px;
      color: #667eea;
      cursor: pointer;
      text-decoration: underline;
    }
    .api-config-toggle:hover {
      color: #764ba2;
    }
    .api-config-fields {
      display: none;
      gap: 12px;
    }
    .api-config-fields.show {
      display: flex;
      flex-direction: column;
    }
    .api-input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .inline-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .small-btn {
      padding: 8px 12px;
      font-size: 13px;
      background: #667eea;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .small-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .api-input-label {
      font-size: 13px;
      color: #6b7280;
      font-weight: 500;
    }
    .api-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      font-family: monospace;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }
    .api-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .api-input::placeholder {
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ“„ PDF/å›¾ç‰‡æ™ºèƒ½è¯†åˆ«ç³»ç»Ÿ</h1>
    <p class="subtitle">æ”¯æŒæ–‡å­—è¯†åˆ«å’Œè¡¨æ ¼æå–ï¼Œçµæ´»è¾“å‡º Word æˆ– Excel æ–‡æ¡£</p>
    
    {% if ark_ok %}
      <div class="hint ok">âœ… æ£€æµ‹åˆ°æœåŠ¡å™¨å·²é…ç½®é»˜è®¤ APIï¼ˆä½†é»˜è®¤ä»éœ€å¡«å†™ API key æˆ–è¾“å…¥ç®¡ç†å¯†ç åæ‰èƒ½å¤„ç†ï¼‰ã€‚</div>
    {% else %}
      <div class="hint error">âŒ æœªæ£€æµ‹åˆ°æœåŠ¡å™¨é»˜è®¤ API é…ç½®ï¼Œè¯·å¡«å†™ API keyï¼Œæˆ–è”ç³»ç®¡ç†å‘˜é…ç½®ç¯å¢ƒå˜é‡åå†ç”¨ç®¡ç†å¯†ç è°ƒç”¨ã€‚</div>
    {% endif %}
    <div class="hint">ä½¿ç”¨å‰è¯·å…ˆå®Œæˆ API é…ç½®ï¼šå¡«å†™è‡ªå·±çš„ API keyï¼Œæˆ–è¾“å…¥ç®¡ç†å¯†ç ä»¥ä½¿ç”¨æœåŠ¡å™¨é»˜è®¤é…ç½®ã€‚å½“å‰å›¾ç‰‡æ¥æºæ¨¡å¼ï¼š<b>{{ source }}</b>ï¼ˆå¯é€šè¿‡ç¯å¢ƒå˜é‡ <code>ARK_SOURCE</code> è®¾ç½®ä¸º <code>both</code> / <code>embedded</code> / <code>page</code>ï¼‰ã€‚</div>

    <form class="row" method="post" enctype="multipart/form-data" action="/upload">
      <!-- API é…ç½®è¾“å…¥æ¡† -->
      <div class="api-config">
        <div class="api-config-title">
          <span>ğŸ”‘ API é…ç½®ï¼ˆå¿…å¡«ï¼Œä»»é€‰å…¶ä¸€ï¼‰</span>
          <span class="api-config-toggle" onclick="toggleApiConfig()">å±•å¼€/æ”¶èµ·</span>
        </div>
        <div class="api-config-fields" id="apiConfigFields">
          <div class="api-input-group">
            <label class="api-input-label">API Key</label>
            <input type="text" name="api_key" class="api-input" placeholder="å¡«å†™åç›´æ¥ä½¿ç”¨è¯¥ key è°ƒç”¨" />
          </div>
          <div class="api-input-group">
            <label class="api-input-label">Base URL</label>
            <input type="text" name="base_url" class="api-input" placeholder="ä¾‹å¦‚: https://ark.cn-beijing.volces.com/api/v3" value="{{ default_base_url }}" />
          </div>
          <div class="api-input-group">
            <label class="api-input-label">ç®¡ç†å¯†ç ï¼ˆä½¿ç”¨æœåŠ¡å™¨é»˜è®¤é…ç½®ï¼‰</label>
            <div class="inline-row">
              <input type="password" name="admin_password" class="api-input" placeholder="è¾“å…¥æ­£ç¡®å¯†ç åå°†ä½¿ç”¨æœåŠ¡å™¨ç¯å¢ƒå˜é‡ä¸­çš„ API é…ç½®" />
              <button type="button" class="small-btn" id="verifyAdminBtn">éªŒè¯å¯†ç å¹¶å¯ç”¨é»˜è®¤é…ç½®</button>
            </div>
            <small class="api-input-label" id="adminPwdHint" style="font-weight:400;color:#9ca3af;">ä¸ä¼šåœ¨å‰ç«¯æ˜¾ç¤ºå…·ä½“å¯†é’¥ï¼Œå¯†ç é”™è¯¯ä¼šè¢«æ‹’ç»ã€‚{% if not admin_password_set %}ï¼ˆå½“å‰æœåŠ¡å™¨æœªè®¾ç½®ç®¡ç†å¯†ç ï¼‰{% endif %}</small>
          </div>
        </div>
      </div>

      <div class="file-input-wrapper" onclick="handleFileClick()">
        <input type="file" id="fileInput" name="files" accept="application/pdf,image/*" multiple />
        <p class="file-label">
          <strong>ç‚¹å‡»é€‰æ‹©</strong> æˆ–æ‹–æ”¾æ–‡ä»¶åˆ°è¿™é‡Œ<br>
          <small>æ”¯æŒ PDFã€PNGã€JPGã€JPEGã€BMPã€WebP</small>
        </p>
      </div>
      
      <!-- æ¨¡å¼é€‰æ‹© -->
      <div class="mode-selector">
        <label class="mode-option">
          <input type="radio" name="mode" value="text" checked />
          <div class="mode-card">
            <div class="mode-icon">ğŸ“</div>
            <div class="mode-title">æ–‡å­—è¯†åˆ«</div>
            <div class="mode-desc">è¯†åˆ«æ‰€æœ‰æ–‡å­—ï¼Œè‡ªåŠ¨åˆ†çº§æ ‡é¢˜</div>
            <div class="mode-output">è¾“å‡º â†’ Word æ–‡æ¡£</div>
          </div>
        </label>
        <label class="mode-option">
          <input type="radio" name="mode" value="table" />
          <div class="mode-card">
            <div class="mode-icon">ğŸ“Š</div>
            <div class="mode-title">è¡¨æ ¼æå–</div>
            <div class="mode-desc">æå–è¡¨æ ¼æ•°æ®ï¼Œä¿ç•™ç»“æ„</div>
            <div class="mode-output">è¾“å‡º â†’ Excel è¡¨æ ¼</div>
          </div>
        </label>
      </div>
      
      <div class="row">
        <button type="submit" id="submitBtn">ğŸš€ å¼€å§‹å¤„ç†</button>
      </div>
    </form>

    <div class="features">
      <div class="feature">
        <div class="feature-icon">ğŸ”</div>
        <div class="feature-text">æ™ºèƒ½è¯†åˆ«å…¨éƒ¨å†…å®¹</div>
      </div>
      <div class="feature">
        <div class="feature-icon">ğŸ“‹</div>
        <div class="feature-text">å¿½ç•¥æ°´å°ç›–ç« å¹²æ‰°</div>
      </div>
      <div class="feature">
        <div class="feature-icon">ğŸ·ï¸</div>
        <div class="feature-text">è‡ªåŠ¨åˆ†çº§æ ‡é¢˜ç»“æ„</div>
      </div>
      <div class="feature">
        <div class="feature-icon">ğŸ“Š</div>
        <div class="feature-text">å®Œæ•´ä¿ç•™è¡¨æ ¼ç»“æ„</div>
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const wrapper = document.querySelector('.file-input-wrapper');
    const label = wrapper.querySelector('.file-label');
    const submitBtn = document.getElementById('submitBtn');
    const apiKeyInput = document.querySelector('input[name="api_key"]');
    const baseUrlInput = document.querySelector('input[name="base_url"]');
    const adminPwdInput = document.querySelector('input[name="admin_password"]');
    const verifyAdminBtn = document.getElementById('verifyAdminBtn');
    const adminPwdHint = document.getElementById('adminPwdHint');
    let adminVerified = false;
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦ç¦ç”¨æäº¤æŒ‰é’®
    function checkSubmitButton() {
      const hasFiles = fileInput.files.length > 0;
      const hasApiKey = apiKeyInput.value.trim().length > 0 && baseUrlInput.value.trim().length > 0;
      const ready = hasApiKey || adminVerified;

      submitBtn.disabled = !hasFiles || !ready;

      if (!ready) {
        wrapper.style.borderColor = '#d1d5db';
        wrapper.style.background = '#fff';
        label.innerHTML = `<strong>è¯·å…ˆå®Œæˆ API é…ç½®</strong><br><small>å¡«å†™ API Key æˆ–è¾“å…¥ç®¡ç†å¯†ç åå†é€‰æ‹©æ–‡ä»¶</small>`;
      } else if (fileInput.files.length === 0) {
        label.innerHTML = `<strong>ç‚¹å‡»é€‰æ‹©</strong> æˆ–æ‹–æ”¾æ–‡ä»¶åˆ°è¿™é‡Œ<br><small>æ”¯æŒ PDFã€PNGã€JPGã€JPEGã€BMPã€WebP</small>`;
        wrapper.style.borderColor = '#d1d5db';
        wrapper.style.background = '#fff';
      }
    }
    
    fileInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        const names = Array.from(this.files).map(f => f.name).join(', ');
        label.innerHTML = `<strong>å·²é€‰æ‹© ${this.files.length} ä¸ªæ–‡ä»¶</strong><br><small>${names}</small>`;
        wrapper.style.borderColor = '#16a34a';
        wrapper.style.background = '#f0fdf4';
      }
      checkSubmitButton();
    });
    
    // ç›‘å¬ API é…ç½®è¾“å…¥
    apiKeyInput.addEventListener('input', checkSubmitButton);
    baseUrlInput.addEventListener('input', checkSubmitButton);
    adminPwdInput.addEventListener('input', () => {
      adminVerified = false;
      adminPwdHint.textContent = 'ä¸ä¼šåœ¨å‰ç«¯æ˜¾ç¤ºå…·ä½“å¯†é’¥ï¼Œå¯†ç é”™è¯¯ä¼šè¢«æ‹’ç»ã€‚{% if not admin_password_set %}ï¼ˆå½“å‰æœåŠ¡å™¨æœªè®¾ç½®ç®¡ç†å¯†ç ï¼‰{% endif %}';
      adminPwdHint.style.color = '#9ca3af';
      checkSubmitButton();
    });
    
    // åˆå§‹æ£€æŸ¥
    checkSubmitButton();
    
    // åˆ‡æ¢ API é…ç½®æ˜¾ç¤º
    function toggleApiConfig() {
      const fields = document.getElementById('apiConfigFields');
      fields.classList.toggle('show');
    }

    // æ–‡ä»¶æ¡†ç‚¹å‡»æ—¶ï¼Œå¦‚æœæœªé…ç½® APIï¼Œåˆ™æç¤º
    function handleFileClick() {
      const hasApiKey = apiKeyInput.value.trim().length > 0 && baseUrlInput.value.trim().length > 0;
      if (!hasApiKey && !adminVerified) {
        alert('è¯·å…ˆå¡«å†™ API Keyï¼Œæˆ–ç‚¹å‡»â€œéªŒè¯å¯†ç å¹¶å¯ç”¨é»˜è®¤é…ç½®â€');
        return;
      }
      fileInput.click();
    }
    
    // é»˜è®¤å±•å¼€ï¼Œä¾¿äºç«‹å³å¡«å†™
    toggleApiConfig();

    // éªŒè¯ç®¡ç†å¯†ç ï¼ˆå‰ç«¯é¢„æ£€ï¼Œä¸æ³„éœ²å¯†é’¥ï¼›ä¸Šä¼ æ—¶åç«¯ä»ä¼šå†æ¬¡æ ¡éªŒï¼‰
    verifyAdminBtn.addEventListener('click', async () => {
      const pwd = adminPwdInput.value.trim();
      if (!pwd) {
        adminPwdHint.textContent = 'è¯·å…ˆè¾“å…¥ç®¡ç†å¯†ç ';
        adminPwdHint.style.color = '#b91c1c';
        adminVerified = false;
        checkSubmitButton();
        return;
      }
      verifyAdminBtn.disabled = true;
      verifyAdminBtn.textContent = 'éªŒè¯ä¸­...';
      try {
        const formData = new FormData();
        formData.append('admin_password', pwd);
        const resp = await fetch('/auth_admin', { method: 'POST', body: formData });
        const data = await resp.json();
        if (resp.ok && data.ok) {
          adminVerified = true;
          adminPwdHint.textContent = 'éªŒè¯é€šè¿‡ï¼Œå·²ä½¿ç”¨æœåŠ¡å™¨é»˜è®¤é…ç½®';
          adminPwdHint.style.color = '#16a34a';
        } else {
          adminVerified = false;
          adminPwdHint.textContent = data.error || 'éªŒè¯å¤±è´¥';
          adminPwdHint.style.color = '#b91c1c';
        }
      } catch (e) {
        adminVerified = false;
        adminPwdHint.textContent = 'ç½‘ç»œå¼‚å¸¸ï¼Œç¨åé‡è¯•';
        adminPwdHint.style.color = '#b91c1c';
      } finally {
        verifyAdminBtn.disabled = false;
        verifyAdminBtn.textContent = 'éªŒè¯å¯†ç å¹¶å¯ç”¨é»˜è®¤é…ç½®';
        checkSubmitButton();
      }
    });
  </script>
</body>
</html>
