<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¤„ç†ä¸­â€¦</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; 
      margin: 0;
      padding: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .card { 
      max-width: 720px; 
      margin: 0 auto; 
      padding: 32px; 
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    }
    h1 { 
      font-size: 22px; 
      margin: 0 0 12px; 
      color: #1a1a2e; 
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .timer-box {
      font-size: 16px;
      font-weight: 600;
      color: #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid rgba(102, 126, 234, 0.2);
      min-width: 80px;
      text-align: center;
    }
    h2 { font-size: 18px; color: #374151; }
    .row { margin-top: 14px; }
    .bar { background:#e5e7eb; height: 12px; border-radius: 8px; overflow:hidden; }
    .bar > .fill { 
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%; 
      width:0%; 
      transition: width .3s ease; 
    }
    .meta { color:#6b7280; }
    .ok { color:#16a34a; }
    .err { color:#b91c1c; }
    .btn { 
      display:inline-block; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:#fff; 
      text-decoration:none; 
      padding:10px 16px; 
      border-radius:8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .hint-box {
      margin-top:8px;
      padding:12px;
      background:#fef3c7;
      border-radius:8px;
      font-size:13px;
      border-left: 3px solid #f59e0b;
    }
    ul { padding-left: 20px; }
    ul li { margin-bottom: 4px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>
      <span>â³ å¤„ç†ä¸­ï¼š{{ t.pdf_name }}</span>
      <span class="timer-box" id="elapsedTime">00:00</span>
    </h1>
    <div class="row meta" id="usageRow" style="display:none; margin-top:0;">
      Token æ¶ˆè€—ï¼š<span id="usageText">-</span>
    </div>
    <div class="meta">
      æ¨¡å¼ï¼š<b>{% if mode == 'table' %}ğŸ“Š è¡¨æ ¼æå– â†’ Excel{% else %}ğŸ“ æ–‡å­—è¯†åˆ« â†’ Word{% endif %}</b>
      &nbsp;|&nbsp;
      é¢„è®¡å¤„ç†å›¾ç‰‡æ€»æ•°ï¼š<b>{{ t.total }}</b>
      {% if t.embedded > 0 and t.pages > 0 %}
        ï¼ˆå†…åµŒå›¾ç‰‡ {{ t.embedded }} + æ•´é¡µæ¸²æŸ“ {{ t.pages }} = {{ t.total }}ï¼‰
      {% elif t.embedded > 0 %}
        ï¼ˆä»…å†…åµŒå›¾ç‰‡ {{ t.embedded }}ï¼‰
      {% elif t.pages > 0 %}
        ï¼ˆä»…æ•´é¡µæ¸²æŸ“ {{ t.pages }}ï¼‰
      {% endif %}
    </div>
    {% if t.embedded > 0 and t.pages == 0 %}
    <div class="hint-box">
      ğŸ’¡ <b>æç¤ºï¼š</b>å½“å‰ä»…æå–PDFä¸­çš„å†…åµŒå›¾ç‰‡å¯¹è±¡ï¼ˆ{{ t.embedded }}ä¸ªï¼‰ã€‚å¦‚éœ€å¤„ç†æ‰€æœ‰é¡µé¢ï¼Œè¯·åœ¨å¯åŠ¨æ—¶è®¾ç½® <code>ARK_SOURCE=both</code> æˆ– <code>page</code>
    </div>
    {% endif %}

    <div class="row bar"><div id="fill" class="fill"></div></div>
    <div class="row meta">
      è¿›åº¦ï¼š<span id="progress">0 / {{ t.total }}</span>
    </div>
    <div class="row" id="statusText">çŠ¶æ€ï¼š{{ t.status }}</div>

    <div class="row" id="errors"></div>

    <div class="row">
      <button id="btnPause" class="btn" style="background:#f59e0b">â¸ï¸ æš‚åœ</button>
      <button id="btnResume" class="btn" style="background:#3b82f6">â–¶ï¸ ç»§ç»­</button>
      <button id="btnStop" class="btn" style="background:#ef4444">â¹ï¸ ç»ˆæ­¢å¹¶ä¿å­˜</button>
    </div>

    <div class="row" id="result"></div>

    <div class="row">
      <a class="btn" href="/" style="background:#10b981">ğŸ  è¿”å›ä¸»é¡µ</a>
    </div>
  </div>

  <script>
    const taskId = "{{ task_id }}";
    const initialMode = "{{ mode }}";  // åˆå§‹æ¨¡å¼ï¼Œä»æœåŠ¡å™¨è·å–
    let startTime = null;  // å¼€å§‹æ—¶é—´æˆ³
    
    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    function formatTime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      
      if (hours > 0) {
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      } else {
        return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
    }
    
    // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
    function updateTimer() {
      // å¦‚æœä»»åŠ¡å·²å®Œæˆï¼Œåœæ­¢è®¡æ—¶å™¨
      if (window.__taskCompleted) {
        if (window.__localTimer) {
          clearInterval(window.__localTimer);
          window.__localTimer = null;
        }
        return;
      }
      if (startTime === null) return;
      const elapsed = (Date.now() / 1000) - startTime;
      document.getElementById('elapsedTime').textContent = formatTime(elapsed);
    }
    
    async function poll(){
      try {
        const resp = await fetch(`/status/${taskId}`);
        if(!resp.ok) return;
        const j = await resp.json();
        const total = j.total || 0;
        const done = j.done || 0;
        const mode = j.mode || initialMode || 'text';
        const pct = total > 0 ? Math.floor(done*100/total) : 0;
        document.getElementById('fill').style.width = pct + '%';
        document.getElementById('progress').textContent = `${done} / ${total}`;
        document.getElementById('statusText').textContent = `çŠ¶æ€ï¼š${j.status}`;

        // æ˜¾ç¤º token æ¶ˆè€—
        const usage = j.usage || {};
        const uPrompt = usage.prompt || 0;
        const uCompletion = usage.completion || 0;
        const uTotal = usage.total || 0;
        if (uPrompt || uCompletion || uTotal) {
          document.getElementById('usageRow').style.display = '';
          document.getElementById('usageText').textContent = `prompt=${uPrompt} | completion=${uCompletion} | total=${uTotal}`;
        }
        
        // æ›´æ–°è®¡æ—¶å™¨ï¼ˆä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„æ—¶é—´ï¼Œæ›´å‡†ç¡®ï¼‰
        if (j.elapsed_time !== undefined) {
          document.getElementById('elapsedTime').textContent = formatTime(j.elapsed_time);
          // å¦‚æœè¿˜æ²¡è®¾ç½®å¼€å§‹æ—¶é—´ï¼Œæ ¹æ®æœåŠ¡å™¨æ—¶é—´æ¨ç®—
          if (startTime === null && j.elapsed_time > 0) {
            startTime = (Date.now() / 1000) - j.elapsed_time;
          }
        }
        const errs = j.errors || [];
        if(errs.length){
          const noContentCount = errs.filter(e => e.error === 'no_content' || e.error === 'no_tables').length;
          let hint = '';
          if(noContentCount > 0 && noContentCount === errs.length){
            const contentType = mode === 'table' ? 'è¡¨æ ¼' : 'æ–‡å­—å†…å®¹';
            hint = `<div class="hint-box" style="margin-top:12px;">
              ğŸ’¡ <b>æç¤ºï¼š</b>æ‰€æœ‰å›¾ç‰‡å‡æœªè¯†åˆ«åˆ°${contentType}ã€‚è¿™é€šå¸¸æ˜¯å› ä¸ºï¼š<br>
              â€¢ å½“å‰ä½¿ç”¨ <code>embedded</code> æ¨¡å¼ï¼Œä½†PDFå†…åµŒå›¾ç‰‡ä¸åŒ…å«${contentType}<br>
              â€¢ å»ºè®®ï¼šåœ¨ <code>.env</code> æ–‡ä»¶ä¸­è®¾ç½® <code>ARK_SOURCE=page</code> æˆ– <code>both</code>ï¼Œç„¶åé‡æ–°ä¸Šä¼ å¤„ç†
            </div>`;
          }
          const items = errs.map(e => `<li><b>${e.image||''}</b> - ${e.error||''}</li>`).join('');
          document.getElementById('errors').innerHTML = `<div class="err">âš ï¸ è­¦å‘Šï¼š${errs.length} æ¡</div><ul>${items}</ul>${hint}`;
        } else {
          document.getElementById('errors').innerHTML = '';
        }
        if(j.status === 'completed'){
          // æ ‡è®°ä»»åŠ¡å·²å®Œæˆ
          window.__taskCompleted = true;
          
          // åœæ­¢è®¡æ—¶å™¨
          if(window.__localTimer){
            clearInterval(window.__localTimer);
            window.__localTimer = null;
          }
          // åœæ­¢è½®è¯¢
          if(window.__pollTimer){
            clearInterval(window.__pollTimer);
            window.__pollTimer = null;
          }
          // ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„æœ€ç»ˆæ—¶é—´ï¼ˆæ›´å‡†ç¡®ï¼‰
          if (j.elapsed_time !== undefined) {
            document.getElementById('elapsedTime').textContent = formatTime(j.elapsed_time);
          }
          
          // ä½¿ç”¨å®é™…æ–‡ä»¶åï¼ˆfile_nameï¼‰è¿›è¡Œä¸‹è½½ï¼Œæ˜¾ç¤ºåç§°ï¼ˆpdf_nameï¼‰ç”¨äºç•Œé¢
          const file_name = j.file_name || j.pdf_name;  // ä¼˜å…ˆä½¿ç”¨æ‰¹æ¬¡ID
          const display_name = j.pdf_name;  // æ˜¾ç¤ºåç§°
          
          let html = '';
          if(mode === 'table'){
            const fname = `${file_name}.xlsx`;
            html = `
              <h2 style="margin-top:16px">âœ… å¤„ç†å®Œæˆ</h2>
              <div class="row">
                <a class="btn" href="/download_excel/${file_name}">ğŸ“¥ ä¸‹è½½ Excel è¡¨æ ¼</a>
              </div>
              <div class="row">
                <h3 style="font-size:16px;margin:10px 0 6px">ğŸ“Š ç”Ÿæˆçš„æ–‡ä»¶</h3>
                <ul><li>ğŸ“Š <a href="/download_excel/${file_name}" download>${display_name}.xlsx</a></li></ul>
              </div>
            `;
          } else {
            const fname = `${file_name}.docx`;
            html = `
              <h2 style="margin-top:16px">âœ… å¤„ç†å®Œæˆ</h2>
              <div class="row">
                <a class="btn" href="/download_word/${file_name}">ğŸ“¥ ä¸‹è½½ Word æ–‡æ¡£</a>
              </div>
              <div class="row">
                <h3 style="font-size:16px;margin:10px 0 6px">ğŸ“„ ç”Ÿæˆçš„æ–‡ä»¶</h3>
                <ul><li>ğŸ“ <a href="/download_word/${file_name}" download>${display_name}.docx</a></li></ul>
              </div>
            `;
          }
          document.getElementById('result').innerHTML = html;
        }
      } catch(e){ /* ignore */ }
    }
    const POLL_MS = {{ poll_ms }};
    window.__pollTimer = setInterval(poll, POLL_MS);
    // å¯åŠ¨æœ¬åœ°è®¡æ—¶å™¨ï¼ˆæ¯ç§’æ›´æ–°ä¸€æ¬¡ï¼Œæ›´æµç•…ï¼‰
    window.__localTimer = setInterval(updateTimer, 1000);
    poll();
    
    // é¡µé¢å¸è½½æ—¶æ¸…ç†è®¡æ—¶å™¨
    window.addEventListener('beforeunload', () => {
      if (window.__pollTimer) clearInterval(window.__pollTimer);
      if (window.__localTimer) clearInterval(window.__localTimer);
    });

    async function post(url){
      try{ const r = await fetch(url, { method:'POST' }); return await r.json(); }catch(e){ return {}; }
    }
    document.getElementById('btnPause').onclick = async ()=>{
      const btn = document.getElementById('btnPause');
      btn.disabled = true;
      btn.style.opacity = '0.6';
      await post(`/task/${taskId}/pause`);
      document.getElementById('statusText').textContent = 'çŠ¶æ€ï¼špaused';
      btn.disabled = false;
      btn.style.opacity = '1';
    };
    document.getElementById('btnResume').onclick = async ()=>{
      const btn = document.getElementById('btnResume');
      btn.disabled = true;
      btn.style.opacity = '0.6';
      await post(`/task/${taskId}/resume`);
      btn.disabled = false;
      btn.style.opacity = '1';
    };
    document.getElementById('btnStop').onclick = async ()=>{
      const btn = document.getElementById('btnStop');
      btn.disabled = true;
      btn.textContent = 'æ­£åœ¨ç»ˆæ­¢...';
      btn.style.opacity = '0.6';
      await post(`/task/${taskId}/stop`);
      document.getElementById('statusText').textContent = 'çŠ¶æ€ï¼šstopping...';
    };
  </script>
</body>
</html>
